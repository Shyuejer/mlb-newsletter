name: MLB newsletter (preview only)

on:
  workflow_dispatch: {}   # manual trigger

permissions:
  contents: read

concurrency:
  group: mlb-newsletter-preview
  cancel-in-progress: true

jobs:
  preview:
    runs-on: ubuntu-latest
    environment: production   # still use your env secrets if needed for OpenAI

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Build newsletter preview (HTML only, no email)
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          SMTP_USER: ${{ secrets.SMTP_USER }}   # ignored if NEWS_RECIPIENTS is empty
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          NEWS_RECIPIENTS: ""   # ðŸ‘ˆ force preview mode (no SMTP send)

          MLB_SEASON: ${{ vars.MLB_SEASON }}
          CONTENDER_GB: ${{ vars.CONTENDER_GB }}
          SMTP_HOST: ${{ vars.SMTP_HOST }}
          SMTP_PORT: ${{ vars.SMTP_PORT }}
          FLM_HOURS_WINDOW: ${{ vars.FLM_HOURS_WINDOW }}
          FLM_MAX_LINKS: ${{ vars.FLM_MAX_LINKS }}
          VERBOSE: ${{ vars.VERBOSE }}
          OPENAI_MIN_INTERVAL_SEC: ${{ vars.OPENAI_MIN_INTERVAL_SEC }}
        run: python main.py

      - name: Upload preview artifact
        if: ${{ hashFiles('newsletter_preview.html') != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: newsletter_preview
          path: newsletter_preview.html
